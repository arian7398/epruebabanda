
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Sistema de Registro de Casos de Extorsión</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome para iconos -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
    }
    
    body {
      background-color: #f5f7fa;
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      color: var(--dark-color);
    }
    
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .section-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 20px;
      margin-bottom: 25px;
      transition: all 0.3s ease;
    }
    
    .section-card:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .section-title {
      color: var(--primary-color);
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 10px;
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .section-title i {
      margin-right: 10px;
      color: var(--secondary-color);
    }
    
    .form-label {
      font-weight: 500;
      color: var(--dark-color);
    }
    
    .nav-tabs {
      border-bottom: 2px solid var(--secondary-color);
      margin-bottom: 25px;
    }
    
    .nav-tabs .nav-link {
      border: none;
      color: var(--dark-color);
      font-weight: 500;
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
      transition: all 0.2s ease;
    }
    
    .nav-tabs .nav-link:hover {
      background-color: rgba(52, 152, 219, 0.1);
    }
    
    .nav-tabs .nav-link.active {
      color: white;
      background-color: var(--secondary-color);
      font-weight: 600;
    }
    
    .btn-primary {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      padding: 8px 20px;
      font-weight: 500;
    }
    
    .btn-primary:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }
    
    .btn-icon {
      background: none;
      border: none;
      color: var(--secondary-color);
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .btn-icon:hover {
      transform: scale(1.2);
    }
    
    .btn-edit {
      color: var(--secondary-color);
    }
    
    .btn-delete {
      color: var(--danger-color);
    }
    
    .btn-view {
      color: var(--success-color);
    }
    
    .item-list {
      list-style: none;
      padding: 0;
    }
    
    .item-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      border: 1px solid #e1e5e8;
      border-radius: 6px;
      padding: 10px;
      background-color: #f8f9fa;
    }
    
    .dynamic-item {
      position: relative;
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #e1e5e8;
      border-radius: 6px;
      background-color: #f8f9fa;
    }
    
    .badge-custom {
      padding: 6px 10px;
      font-weight: 500;
      border-radius: 30px;
    }
    
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s;
    }
    
    .spinner-overlay.show {
      visibility: visible;
      opacity: 1;
    }
    
    /* Mejora de la responsividad */
    @media (max-width: 768px) {
      .section-card {
        padding: 15px;
      }
      
      .nav-tabs .nav-link {
        padding: 8px 15px;
      }
      
      .form-label {
        font-size: 0.95rem;
      }
      
      .section-title {
        font-size: 1.3rem;
      }
    }
    
    @media (max-width: 576px) {
      .nav-tabs .nav-link {
        padding: 8px 10px;
        font-size: 0.9rem;
      }
      
      .section-title {
        font-size: 1.2rem;
      }
      
      .item-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .btn-icon {
        font-size: 1rem;
      }
    }
  </style>
</head>

<body>
  <!-- Spinner para carga -->
  <div class="spinner-overlay" id="loadingSpinner">
    <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <div class="app-container py-4">
    <header class="text-center mb-4">
      <h1 class="display-5 fw-bold">Sistema de Registro de Casos de Extorsión</h1>
      <p class="text-muted">Ministerio Público - Fiscalía Especializada</p>
    </header>
    
    <!-- Pestañas principales -->
    <ul class="nav nav-tabs" id="mainTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-panel" type="button" role="tab" aria-controls="form-panel" aria-selected="true">
          <i class="fas fa-file-alt me-2"></i>Formulario
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records-panel" type="button" role="tab" aria-controls="records-panel" aria-selected="false">
          <i class="fas fa-table me-2"></i>Registros
        </button>
      </li>
    </ul>
    
    <div class="tab-content" id="mainTabContent">
      <!-- Panel de Formulario -->
      <div class="tab-pane fade show active" id="form-panel" role="tabpanel" aria-labelledby="form-tab">
        <form id="casoForm">
          <input type="hidden" id="id" name="id">
          <input type="hidden" id="modoEdicion" name="modoEdicion" value="false">
          
          <!-- 1. Información General -->
          <div class="section-card">
            <h3 class="section-title"><i class="fas fa-info-circle"></i>1. Información General</h3>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="fiscalia" class="form-label">Fiscalía</label>
                <input type="text" class="form-control" id="fiscalia" name="fiscalia" required>
              </div>
              <div class="col-md-6">
                <label for="fiscalacargo" class="form-label">Fiscal a Cargo</label>
                <input type="text" class="form-control" id="fiscalacargo" name="fiscalacargo" required>
              </div>
              <div class="col-md-6">
                <label for="unidadInteligencia" class="form-label">Unidad a Cargo de Acciones de Inteligencia</label>
                <input type="text" class="form-control" id="unidadInteligencia" name="unidadInteligencia">
              </div>
              <div class="col-md-6">
                <label for="instructorCargo" class="form-label">Instructor a Cargo</label>
                <input type="text" class="form-control" id="instructorCargo" name="instructorCargo">
              </div>
            </div>
          </div>
          
          <!-- 2. Detalles del Caso -->
          <div class="section-card">
            <h3 class="section-title"><i class="fas fa-folder-open"></i>2. Detalles del Caso</h3>
            <div class="row g-3">
              <!-- Forma de Inicio de Investigación con nueva lista -->
              <div class="col-md-6">
                <label for="formaInicio" class="form-label">Forma de Inicio de Investigación</label>
                <div class="input-group">
                  <select class="form-select" id="formaInicio" name="formaInicio" required>
                    <option value="">Seleccionar...</option>
                    <option value="Denuncia de Parte">Denuncia de Parte</option>
                    <option value="Información de Fuente Humana">Información de Fuente Humana</option>
                    <option value="Informante">Informante</option>
                    <option value="Testigo Protegido">Testigo Protegido</option>
                    <option value="Búsqueda de Fuente Abierta">Búsqueda de Fuente Abierta</option>
                    <option value="Colaborador Eficaz">Colaborador Eficaz</option>
                    <option value="Otros">Otros</option>
                  </select>
                  <button class="btn btn-outline-secondary" type="button" onclick="mostrarModalOtros('formaInicio')" id="btnOtrosFormaInicio" style="display: none;">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <div id="otrosFormaInicioContainer" style="display: none;" class="mt-2">
                  <input type="text" class="form-control" id="otrosFormaInicio" placeholder="Especifique otra forma de inicio">
                </div>
              </div>

              <div class="col-md-6">
                <label for="carpetaFiscal" class="form-label">Carpeta Fiscal</label>
                <input type="text" class="form-control" id="carpetaFiscal" name="carpetaFiscal" required>
              </div>
              <div class="col-md-6">
                <label for="fechaHecho" class="form-label">Fecha del Hecho</label>
                <input type="date" class="form-control" id="fechaHecho" name="fechaHecho">
              </div>
              <div class="col-md-6">
                <label for="fechaIngresoFiscal" class="form-label">Fecha Ingreso Carpeta Fiscal</label>
                <input type="date" class="form-control" id="fechaIngresoFiscal" name="fechaIngresoFiscal">
              </div>

            </div>
          </div>
          
          <!-- 3. Información del Agraviado -->
          <div class="section-card">
            <h3 class="section-title"><i class="fas fa-user-shield"></i>3. Información del Agraviado</h3>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="tipoAgraviado" class="form-label">Tipo de Agraviado</label>
                <select class="form-select" id="tipoAgraviado" name="tipoAgraviado" required>
                  <option value="">Seleccionar...</option>
                  <option value="Natural">Natural</option>
                  <option value="Jurídica">Jurídica</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Agraviados</label>
                <div id="agraviados-container">
                  <!-- Aquí se agregarán dinámicamente los agraviados -->
                </div>
                <input type="hidden" id="agraviadosJson" name="agraviadosJson">
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnAgregarAgraviado">
                  <i class="fas fa-plus me-2"></i>Agregar Agraviado
                </button>
              </div>
            </div>
          </div>
          
          <!-- 4. Información del Denunciado -->
          <div class="section-card">
            <h3 class="section-title"><i class="fas fa-user-times"></i>4. Información del Denunciado</h3>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="delitos" class="form-label">Delitos</label>
                <input type="text" class="form-control" id="delitos" name="delitos" required>
              </div>
              <div class="col-md-6">
                <label for="lugarHechos" class="form-label">Lugar de los Hechos</label>
                <input type="text" class="form-control" id="lugarHechos" name="lugarHechos" required>
              </div>
              <div class="col-12 mt-3">
                <label class="form-label">Denunciado o Alias</label>
                <div id="denunciados-container">
                  <!-- Aquí se agregarán dinámicamente los denunciados -->
                </div>
                <input type="hidden" id="denunciadosJson" name="denunciadosJson">
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnAgregarDenunciado">
                  <i class="fas fa-plus me-2"></i>Agregar Denunciado
                </button>
              </div>

              <!-- Datos de Interés del Denunciado con lista------------------------------------------------------ -->
              <div class="col-md-6">
                <label for="datosInteresDenunciado" class="form-label">Datos de Interés del Denunciado</label>
                <div class="mb-2">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input datos-interes-check" type="checkbox" value="Tatuajes" id="datoInteres-tatuajes">
                    <label class="form-check-label" for="datoInteres-tatuajes">Tatuajes</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input datos-interes-check" type="checkbox" value="Cicatrices" id="datoInteres-cicatrices">
                    <label class="form-check-label" for="datoInteres-cicatrices">Cicatrices</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" value="Otros" id="datoInteres-otros">
                    <label class="form-check-label" for="datoInteres-otros">Otros</label>
                  </div>
                </div>
                <div id="otrosDatosInteresContainer" style="display: none;">
                  <input type="text" class="form-control" id="otrosDatosInteres" placeholder="Especificar otros datos de interés">
                </div>
                <input type="hidden" id="datosInteresDenunciadoJson" name="datosInteresDenunciadoJson">
              </div>

              <!-- Nombre/Apodo de Banda Criminal con botón agregar -->
              <div class="col-md-6">
                <label for="nombreBandaCriminal" class="form-label">Nombre/Apodo de Banda Criminal</label>
                <div id="bandas-container">
                  <!-- Aquí se agregarán dinámicamente las bandas -->
                  <div class="input-group mb-2">
                    <input type="text" class="form-control banda-input" placeholder="Nombre o apodo de la banda">
                    <button class="btn btn-outline-secondary" type="button" onclick="agregarBanda()">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                  
                </div>
                <input type="hidden" id="bandasCriminalesJson" name="bandasCriminalesJson">
              </div>

              <!-- Cantidad de Miembros con nombre modificado -->
              <div class="col-md-6">
                <label for="cantidadMiembrosBanda" class="form-label">Cantidad de miembros de la banda/organización criminal</label>
                <input type="number" class="form-control" id="cantidadMiembrosBanda" name="cantidadMiembrosBanda" min="0" placeholder="Ingrese la cantidad">
              </div>
              <!-- -------------------------------------------------------------------------- -->

              <div class="col-md-6">
                <label for="modalidadViolencia" class="form-label" >Modalidad de Violencia</label>
                <textarea class="form-control" id="modalidadViolencia" name="modalidadViolencia" rows="2" placeholder="Detallar"></textarea>
              </div>
              <div class="col-md-6">
                <label for="modalidadAmenaza" class="form-label">Modalidad de Amenaza</label>
                <textarea class="form-control" id="modalidadAmenaza" name="modalidadAmenaza" rows="2" placeholder="Detallar"></textarea>
              </div>
              <div class="col-md-6">
                <label for="atentadosCometidos" class="form-label">Atentados Cometidos</label>
                <textarea class="form-control" id="atentadosCometidos" name="atentadosCometidos" rows="2" placeholder="Detallar"></textarea>
              </div>
            </div>
          </div>
          
          <!-- 5. Instrumentos Utilizados para la Extorsión -->
          <div class="section-card">
            <h3 class="section-title"><i class="fas fa-tools"></i>5. Instrumentos y Métodos de Extorsión</h3>
            <div class="row g-3">
              <!-- Instrumentos Utilizados para la Extorsión con nueva lista -->
              <div class="col-md-6">
                <label class="form-label">Instrumentos Utilizados para la Extorsión</label>
                <div id="instrumentos-container">
                  <div class="form-check">
                    <input class="form-check-input instrumento-check" type="checkbox" value="Motos" id="instrumento-motos">
                    <label class="form-check-label" for="instrumento-motos">Motos</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input instrumento-check" type="checkbox" value="Carros" id="instrumento-carros">
                    <label class="form-check-label" for="instrumento-carros">Carros</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="Otro" id="instrumento-otro">
                    <label class="form-check-label" for="instrumento-otro">Otro</label>
                  </div>
                  <div id="instrumento-otro-texto-container" style="display: none;" class="mt-2">
                    <div class="input-group mb-2">
                      <input type="text" class="form-control" id="instrumento-otro-texto" placeholder="Especificar otro instrumento">
                      <button class="btn btn-outline-secondary" type="button" onclick="agregarOtroInstrumento()">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                    <div id="otros-instrumentos-lista">
                      <!-- Aquí se mostrarán otros instrumentos agregados -->
                    </div>
                  </div>
                </div>
                <input type="hidden" id="instrumentosJson" name="instrumentosJson" value="[]">
              </div>

              <!-- Forma que se Obliga el Pago con nueva lista -->
              <div class="col-md-6">
                <label for="formaPago" class="form-label">Forma que se Obliga el Pago</label>
                <select class="form-select" id="formaPago" name="formaPago">
                  <option value="">Seleccionar...</option>
                  <option value="Yape">Yape</option>
                  <option value="Plin">Plin</option>
                  <option value="Transferencias">Transferencias</option>
                  <option value="Efectivo">Efectivo</option>
                  <option value="Otro">Otro</option>
                </select>
                <div id="otraFormaPagoContainer" style="display: none;" class="mt-2">
                  <input type="text" class="form-control" id="otraFormaPago" placeholder="Especificar otra forma de pago">
                </div>
              </div>


              <!-- -------------------------------------------------------------------------- -->
              <div class="col-md-6">
                <label class="form-label">Números Telefónicos Utilizados para Extorsión</label>
                <div id="numeros-container">
                  <!-- Aquí se agregarán dinámicamente los números -->
                </div>
                <input type="hidden" id="numerosTelefonicosJson" name="numerosTelefonicosJson">
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnAgregarNumero">
                  <i class="fas fa-plus me-2"></i>Agregar Número
                </button>
              </div>

              <div class="col-md-6">
                <label class="form-label">IMEI de los Números Telefónicos</label>
                <div id="imeis-container">
                  <!-- Aquí se agregarán dinámicamente los IMEIs -->
                </div>
                <input type="hidden" id="imeisTelefonicosJson" name="imeisTelefonicosJson">
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnAgregarImei">
                  <i class="fas fa-plus me-2"></i>Agregar IMEI
                </button>
              </div>
              <!-- Número para método de Pago con botón agregar más -->
              <div class="col-md-6">
                <label class="form-label">Número Telefónico o Cuenta Corriente para método de Pago</label>
                <div id="cuentas-pago-container">
                  <!-- Aquí se agregarán dinámicamente las cuentas -->
                  <div class="input-group mb-2">
                    <input type="text" class="form-control cuenta-pago-input" placeholder="Número o cuenta para pago">
                    <button class="btn btn-outline-secondary" type="button" onclick="agregarCuentaPago()">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </div>
                <input type="hidden" id="cuentasPagoJson" name="cuentasPagoJson">
              </div>

              <div class="col-md-6">
                <label class="form-label">Nombres de Titulares de Pago</label>
                <div id="titulares-container">
                  <!-- Aquí se agregarán dinámicamente los titulares -->
                </div>
                <input type="hidden" id="titularesPagoJson" name="titularesPagoJson">
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnAgregarTitular">
                  <i class="fas fa-plus me-2"></i>Agregar Titular
                </button>
              </div>
            </div>
          </div>
          
          <!-- 6. Datos de Interés de Pagos -->
          <div class="section-card">
            <h3 class="section-title"><i class="fas fa-money-bill-wave"></i>6. Datos de Interés de Pagos</h3>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="tipoPago" class="form-label">Tipo de Pago</label>
                <select class="form-select" id="tipoPago" name="tipoPago">
                  <option value="">Seleccionar...</option>
                  <option value="Mensual">Mensual</option>
                  <option value="Quincenal">Quincenal</option>
                  <option value="Semanal">Semanal</option>
                  <option value="Único">Único</option>
                  <option value="Otro">Otro</option>
                </select>
                <div id="tipoPagoOtroContainer" style="display: none;" class="mt-2">
                  <input type="text" class="form-control" id="tipoPagoOtros" name="tipoPagoOtros" placeholder="Especifique otro tipo">
                </div>
              </div>
              <div class="col-md-6">
                <label for="montoSolicitado" class="form-label">Monto Solicitado</label>
                <div class="input-group">
                  <span class="input-group-text">S/</span>
                  <input type="number" class="form-control" id="montoSolicitado" name="montoSolicitado" step="0.01" min="0">
                </div>
              </div>
              <div class="col-md-6">
                <label for="montoPagado" class="form-label">Monto Pagado</label>
                <div class="input-group">
                  <span class="input-group-text">S/</span>
                  <input type="number" class="form-control" id="montoPagado" name="montoPagado" step="0.01" min="0">
                </div>
              </div>
              <div class="col-md-6">
                <label for="numeroPagos" class="form-label">Número de Veces que se Efectuó el Pago</label>
                <input type="number" class="form-control" id="numeroPagos" name="numeroPagos" min="0">
              </div>
            </div>
          </div>
          
          <!-- 7. Sumilla de Hechos -->
          <div class="section-card">
            <h3 class="section-title"><i class="fas fa-align-left"></i>7. Sumilla de los Hechos</h3>
            <div class="row">
              <div class="col-12">
                <textarea class="form-control" id="sumillaHechos" name="sumillaHechos" rows="5" required></textarea>
              </div>
            </div>
          </div>
          
          <!-- 8. Observaciones -->
          <div class="section-card">
            <h3 class="section-title"><i class="fas fa-clipboard"></i>8. Observaciones</h3>
            <div class="row">
              <div class="col-12">
                <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
              </div>
            </div>
          </div>
          
          <!-- Botones del formulario -->
          <div class="d-flex justify-content-between mt-4 mb-5">
            <button type="button" class="btn btn-secondary" id="btnLimpiar">
              <i class="fas fa-eraser me-2"></i>Limpiar Formulario
            </button>
            <button type="submit" class="btn btn-primary" id="btnGuardar">
              <i class="fas fa-save me-2"></i>Guardar Registro
            </button>
          </div>
        </form>
      </div>
      
      <!-- Panel de Registros -->
      <div class="tab-pane fade" id="records-panel" role="tabpanel" aria-labelledby="records-tab">
        <div class="section-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="section-title mb-0"><i class="fas fa-table"></i>Registros de Casos</h3>
            <div class="input-group" style="max-width: 300px;">
              <input type="text" class="form-control" id="buscarRegistro" placeholder="Buscar...">
              <button class="btn btn-outline-secondary" type="button" id="btnBuscar">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-light">
                <tr>
                  <th>Carpeta Fiscal</th>
                  <th>Fiscal a Cargo</th>
                  <th>Fecha de Ingreso</th>
                  <th>Agraviado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="registros-body">
                <!-- Aquí se cargarán los registros dinámicamente -->
              </tbody>
            </table>
          </div>
          
          <div id="no-registros-message" class="alert alert-info text-center" style="display: none;">
            <i class="fas fa-info-circle me-2"></i>No hay registros disponibles.
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal para Ver Detalles -->
  <div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="detalleModalLabel">Detalles del Caso</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="detalleModalBody">
          <!-- Contenido dinámico -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="btnEditarDesdeDetalle">Editar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal de confirmación de eliminación -->
  <div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="eliminarModalLabel">Confirmar Eliminación</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro que desea eliminar este registro? Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Variables globales
    let registrosLocales = [];
    let registroAEliminarId = null;
    let modoEdicion = false;
    
    // Elementos dinámicos del formulario
    let agraviados = [];
    let denunciados = [];
    let numerosTelefonicos = [];
    let imeisTelefonicos = [];
    let titularesPago = [];

    // Variables para elementos dinámicos
    let bandasCriminales = [];
    let otrosInstrumentos = [];
    let cuentasPago = [];
    

    // Inicialización cuando el DOM está cargado
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar la hoja de cálculo al cargar la página
      inicializarSheet();
      
      // Configurar manejadores de eventos
      document.getElementById('casoForm').addEventListener('submit', guardarFormulario);
      document.getElementById('btnLimpiar').addEventListener('click', limpiarFormulario);
      document.getElementById('btnAgregarAgraviado').addEventListener('click', agregarAgraviado);
      document.getElementById('btnAgregarDenunciado').addEventListener('click', agregarDenunciado);
      document.getElementById('btnAgregarNumero').addEventListener('click', agregarNumeroTelefonico);
      document.getElementById('btnAgregarImei').addEventListener('click', agregarImeiTelefonico);
      document.getElementById('btnAgregarTitular').addEventListener('click', agregarTitularPago);
      document.getElementById('btnConfirmarEliminar').addEventListener('click', eliminarRegistro);
      document.getElementById('btnEditarDesdeDetalle').addEventListener('click', editarDesdeDetalle);
      document.getElementById('btnBuscar').addEventListener('click', buscarRegistros);
      document.getElementById('buscarRegistro').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') buscarRegistros();
      });


      // Forma de inicio "Otros"
      const formaInicioSelect = document.getElementById('formaInicio');
      const otrosFormaInicioContainer = document.getElementById('otrosFormaInicioContainer');
      const btnOtrosFormaInicio = document.getElementById('btnOtrosFormaInicio');
      
      formaInicioSelect.addEventListener('change', function() {
        if (this.value === 'Otros') {
          otrosFormaInicioContainer.style.display = 'block';
          btnOtrosFormaInicio.style.display = 'block';
        } else {
          otrosFormaInicioContainer.style.display = 'none';
          btnOtrosFormaInicio.style.display = 'none';
        }
      });

        // Datos de interés del denunciado "Otros"
      document.getElementById('datoInteres-otros').addEventListener('change', function() {
        document.getElementById('otrosDatosInteresContainer').style.display = 
          this.checked ? 'block' : 'none';
      });
      
      /*       // Instrumento "Otro"
      document.getElementById('instrumento-otro').addEventListener('change', function() {
        document.getElementById('otros-instrumentos-container').style.display = 
          this.checked ? 'block' : 'none';
      });
       */
      // Forma de pago "Otro"
      document.getElementById('formaPago').addEventListener('change', function() {
        document.getElementById('otraFormaPagoContainer').style.display = 
          this.value === 'Otro' ? 'block' : 'none';
      });
      
      // Inicializar agraviados
      inicializarAgraviados();
    
      // Manejar tipo de pago "Otro"
      document.getElementById('tipoPago').addEventListener('change', function() {
        const otroContainer = document.getElementById('tipoPagoOtroContainer');
        otroContainer.style.display = this.value === 'Otro' ? 'block' : 'none';
      });
      
      // Manejar instrumento "Otro"
      document.getElementById('instrumento-otro').addEventListener('change', function() {
        document.getElementById('instrumento-otro-texto').style.display = this.checked ? 'block' : 'none';
      });
      
      // Cargar datos iniciales
      cargarRegistrosLocales();
      
      // Configurar el cambio de pestañas para cargar registros
      document.getElementById('records-tab').addEventListener('click', function() {
        cargarRegistrosLocales();
      });

        // Para bandas criminales
      if (document.getElementById('btnAgregarBanda')) {
        document.getElementById('btnAgregarBanda').addEventListener('click', agregarBanda);
      }
      
      // Para cuentas de pago
      if (document.getElementById('btnAgregarCuenta')) {
        document.getElementById('btnAgregarCuenta').addEventListener('click', agregarCuentaPago);
      }
      
      // Para manejar el tipo de empresa en agraviados
      document.querySelectorAll('.agraviado-tipo-empresa').forEach(function(select) {
        select.addEventListener('change', function() {
          const empresaContainer = this.closest('.agraviado-item').querySelector('.agraviado-empresa-container');
          if (empresaContainer) {
            empresaContainer.style.display = this.value ? 'block' : 'none';
          }
        });
      });
      
      // Inicializar "Otros Instrumentos" contenedor
      if (document.getElementById('otros-instrumentos-container')) {
        document.getElementById('instrumento-otro').addEventListener('change', function() {
          document.getElementById('otros-instrumentos-container').style.display = 
            this.checked ? 'block' : 'none';
        });
      }
      
      // Para manejar los checkboxes de datos de interés
      if (document.getElementById('datoInteres-otros')) {
        document.getElementById('datoInteres-otros').addEventListener('change', function() {
          document.getElementById('otrosDatosInteresContainer').style.display = 
            this.checked ? 'block' : 'none';
        });
      }

      document.getElementById('instrumento-otro').addEventListener('change', function() {
        const container = document.getElementById('instrumento-otro-texto-container');
        if (container) {
          container.style.display = this.checked ? 'block' : 'none';
        }
      });
    });
    //----------------------------------------------------------------------------------------------------
    // Nueva estructura para agraviados
    function inicializarAgraviados() {
      // Configurar el botón para agregar agraviados
      document.getElementById('btnAgregarAgraviado').addEventListener('click', agregarAgraviado);
      
      // Agregar el primer agraviado por defecto
      agregarAgraviado();
    }

    // Agregar un nuevo agraviado
    function agregarAgraviado() {
      const container = document.getElementById('agraviados-container');
      const id = 'agraviado-' + Date.now();
      
      const div = document.createElement('div');
      div.className = 'agraviado-item card mb-3';
      div.id = id;
      div.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="card-title mb-0">Datos del Agraviado</h6>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarAgraviado('${id}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control agraviado-nombre" placeholder="Nombre completo del agraviado">
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Función</label>
              <select class="form-select agraviado-funcion">
                <option value="">Seleccionar...</option>
                <option value="Pública">Función Pública</option>
                <option value="Privada">Función Privada</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Tipo de Empresa</label>
              <select class="form-select agraviado-tipo-empresa">
                <option value="">Seleccionar...</option>
                <option value="Pública">Empresa Pública</option>
                <option value="Privada">Empresa Privada</option>
              </select>
            </div>
            
            <div class="col-md-12 agraviado-empresa-container" style="display: none;">
              <label class="form-label">Nombre de la Empresa</label>
              <input type="text" class="form-control agraviado-empresa" placeholder="Nombre de la empresa">
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(div);
      
      // Configurar eventos para mostrar/ocultar el campo de empresa
      const tipoEmpresaSelect = div.querySelector('.agraviado-tipo-empresa');
      const empresaContainer = div.querySelector('.agraviado-empresa-container');
      
      tipoEmpresaSelect.addEventListener('change', function() {
        empresaContainer.style.display = this.value ? 'block' : 'none';
      });
      
      actualizarAgraviadosJson();
    }

    // Eliminar un agraviado
    function eliminarAgraviado(id) {
      const agraviado = document.getElementById(id);
      if (agraviado) {
        agraviado.remove();
        actualizarAgraviadosJson();
      }
    }

    // Actualizar el JSON de agraviados
    function actualizarAgraviadosJson() {
      const agraviados = [];
      
      document.querySelectorAll('.agraviado-item').forEach(function(item) {
        const nombre = item.querySelector('.agraviado-nombre').value.trim();
        const funcion = item.querySelector('.agraviado-funcion').value;
        const tipoEmpresa = item.querySelector('.agraviado-tipo-empresa').value;
        const empresa = item.querySelector('.agraviado-empresa').value.trim();
        
        if (nombre) {
          agraviados.push({
            id: item.id,
            nombre: nombre,
            funcion: funcion,
            tipoEmpresa: tipoEmpresa,
            empresa: empresa
          });
        }
      });
      
      document.getElementById('agraviadosJson').value = JSON.stringify(agraviados);
    }


    ///-------------------------------------------------------------------------

    // Función para inicializar la hoja de cálculo
    function inicializarSheet() {
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Hoja de cálculo inicializada:', result);
        })
        .withFailureHandler(function(error) {
          console.error('Error al inicializar hoja:', error);
        })
        .inicializarSheet();
    }
    
    // Función para mostrar el spinner de carga
    function mostrarCargando() {
      document.getElementById('loadingSpinner').classList.add('show');
    }
    
    // Función para ocultar el spinner de carga
    function ocultarCargando() {
      document.getElementById('loadingSpinner').classList.remove('show');
    }
    
    // Mostrar alerta
    function mostrarAlerta(mensaje, tipo, autoclose = true) {
      const alertPlaceholder = document.createElement('div');
      alertPlaceholder.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-4`;
      alertPlaceholder.style.zIndex = '9999';
      alertPlaceholder.style.maxWidth = '90%';
      alertPlaceholder.style.width = '500px';
      alertPlaceholder.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
      
      alertPlaceholder.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      document.body.appendChild(alertPlaceholder);
      
      if (autoclose) {
        setTimeout(() => {
          alertPlaceholder.remove();
        }, 5000);
      }
    }
    
    // Función para generar ID único
    function generarId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    // Función para guardar el formulario
    function guardarFormulario(event) {
      event.preventDefault();
      mostrarCargando();
      
      try {
        const formData = recopilarDatosFormulario();
        console.log('Datos a enviar:', formData);
        
        if (modoEdicion) {
          // Actualizar registro existente
          google.script.run
            .withSuccessHandler(function(result) {
              ocultarCargando();
              if (result.success) {
                mostrarAlerta('Registro actualizado correctamente.', 'success');
                limpiarFormulario();
                modoEdicion = false;
                document.getElementById('btnGuardar').innerHTML = '<i class="fas fa-save me-2"></i>Guardar Registro';
                cargarRegistrosLocales();
              } else {
                mostrarAlerta('Error al actualizar: ' + result.message, 'danger');
              }
            })
            .withFailureHandler(function(error) {
              ocultarCargando();
              mostrarAlerta('Error al actualizar: ' + error, 'danger');
            })
            .actualizarRegistroEnSheet(formData);
        } else {
          // Guardar nuevo registro
          google.script.run
            .withSuccessHandler(function(result) {
              ocultarCargando();
              if (result.success) {
                mostrarAlerta('Registro guardado correctamente.', 'success');
                limpiarFormulario();
                cargarRegistrosLocales();
              } else {
                mostrarAlerta('Error al guardar: ' + result.message, 'danger');
              }
            })
            .withFailureHandler(function(error) {
              ocultarCargando();
              mostrarAlerta('Error al guardar: ' + error, 'danger');
            })
            .guardarDatos(formData);
        }
      } catch (error) {
        ocultarCargando();
        mostrarAlerta('Error al procesar el formulario: ' + error, 'danger');
        console.error('Error en guardarFormulario:', error);
      }
    }
    
    // Función para recopilar datos del formulario
    
    function recopilarDatosFormulario() {
      try {
        // Capturar datos del formulario
        const formData = {
          id: document.getElementById('id')?.value || generarId(),
          
          // Información General
          fiscalia: document.getElementById('fiscalia')?.value || '',
          fiscalacargo: document.getElementById('fiscalacargo')?.value || '',
          unidadInteligencia: document.getElementById('unidadInteligencia')?.value || '',
          instructorCargo: document.getElementById('instructorCargo')?.value || '',
          
          // Detalles del Caso
          formaInicio: document.getElementById('formaInicio')?.value || '',
          carpetaFiscal: document.getElementById('carpetaFiscal')?.value || '',
          fechaHecho: document.getElementById('fechaHecho')?.value || '',
          fechaIngresoFiscal: document.getElementById('fechaIngresoFiscal')?.value || '',
          fechadeingreso: document.getElementById('fechadeingreso')?.value || '',
          
          // Información del Agraviado
          tipoAgraviado: document.getElementById('tipoAgraviado')?.value || '',
          agraviados: agraviados || [],
          
          // Información del Denunciado
          delitos: document.getElementById('delitos')?.value || '',
          lugarHechos: document.getElementById('lugarHechos')?.value || '',
          denunciadosAlias: denunciados || [],
          
          // Datos de interés del denunciado
          datosInteresDenunciado: recopilarDatosInteresDenunciado(),
          
          nombreBandaCriminal: document.getElementById('nombreBandaCriminal')?.value || '',
          cantidadMiembrosBanda: document.getElementById('cantidadMiembrosBanda')?.value || '',
          modalidadViolencia: document.getElementById('modalidadViolencia')?.value || '',
          modalidadAmenaza: document.getElementById('modalidadAmenaza')?.value || '',
          atentadosCometidos: document.getElementById('atentadosCometidos')?.value || '',
          
          // Instrumentos y Métodos de Extorsión
          instrumentosExtorsion: recopilarInstrumentosExtorsion(),
          formaPago: document.getElementById('formaPago')?.value || '',
          numerosTelefonicos: numerosTelefonicos || [],
          imeisTelefonicos: imeisTelefonicos || [],
          cuentaPago: document.getElementById('cuentaPago')?.value || '',
          titularesPago: titularesPago || [],
          
          // Datos de Interés de Pagos
          tipoPago: document.getElementById('tipoPago')?.value || '',
          montoSolicitado: document.getElementById('montoSolicitado')?.value || '',
          montoPagado: document.getElementById('montoPagado')?.value || '',
          numeroPagos: document.getElementById('numeroPagos')?.value || '',
          tipoPagoOtros: document.getElementById('tipoPagoOtros')?.value || '',
          
          // Sumilla y Observaciones
          sumillaHechos: document.getElementById('sumillaHechos')?.value || '',
          observaciones: document.getElementById('observaciones')?.value || ''
        };
        
        return formData;
      } catch (error) {
        console.error("Error al recopilar datos del formulario:", error);
        throw error;
      }
    }

    // Función para recopilar datos de interés del denunciado
    function recopilarDatosInteresDenunciado() {
      const datos = {
        texto: document.getElementById('datosInteresDenunciado')?.value || '',
        tatuajes: document.getElementById('datoInteres-tatuajes')?.checked || false,
        cicatrices: document.getElementById('datoInteres-cicatrices')?.checked || false,
        otros: document.getElementById('datoInteres-otros')?.checked || false,
        otrosTexto: document.getElementById('otrosDatosInteres')?.value || ''
      };
      
      return datos;
    }


    // Función para recopilar información de agraviados con detalles
    function recopilarAgraviados() {
      const agraviadosConDetalles = [];
      
      // Recorrer todos los items de agraviados
      document.querySelectorAll('.agraviado-item').forEach(function(item) {
        const nombre = item.querySelector('.agraviado-nombre')?.value || '';
        
        if (nombre.trim()) {
          agraviadosConDetalles.push({
            id: item.id || generateId(),
            nombre: nombre.trim(),
            funcion: item.querySelector('.agraviado-funcion')?.value || '',
            tipoEmpresa: item.querySelector('.agraviado-tipo-empresa')?.value || '',
            empresa: item.querySelector('.agraviado-empresa')?.value || ''
          });
        }
      });
      
      return agraviadosConDetalles.length > 0 ? agraviadosConDetalles : agraviados; // Fallback a agraviados originales
    }

    // Función para obtener bandas criminales
    function obtenerBandasCriminales() {
      const bandas = [];
      
      // Buscar todos los inputs de bandas (excluyendo el de agregar nueva)
      document.querySelectorAll('.banda-item input').forEach(function(input) {
        if (input.value.trim()) {
          bandas.push(input.value.trim());
        }
      });
      
      // Si no hay bandas en el nuevo formato, intentar obtener del campo original
      if (bandas.length === 0 && document.getElementById('nombreBandaCriminal')) {
        const bandaOriginal = document.getElementById('nombreBandaCriminal').value.trim();
        if (bandaOriginal) {
          bandas.push(bandaOriginal);
        }
      }
      
      return bandas;
    }

    // Función para obtener cuentas de pago
    function obtenerCuentasPago() {
      const cuentas = [];
      
      // Buscar todos los inputs de cuentas (excluyendo el de agregar nueva)
      document.querySelectorAll('.cuenta-item input').forEach(function(input) {
        if (input.value.trim()) {
          cuentas.push(input.value.trim());
        }
      });
      
      // Si no hay cuentas en el nuevo formato, intentar obtener del campo original
      if (cuentas.length === 0 && document.getElementById('cuentaPago')) {
        const cuentaOriginal = document.getElementById('cuentaPago').value.trim();
        if (cuentaOriginal) {
          cuentas.push(cuentaOriginal);
        }
      }
      
      return cuentas;
    }





    //--------------------------------------------------
    // Función para agregar bandas criminales
    function agregarBanda() {
      try {
        const bandasContainer = document.getElementById('bandas-container');
        if (!bandasContainer) return;
        
        const inputBanda = bandasContainer.querySelector('input[type="text"]');
        if (!inputBanda) return;
        
        const nombreBanda = inputBanda.value.trim();
        if (!nombreBanda) {
          alert("Por favor ingrese un nombre de banda");
          return;
        }
        
        // Crear nuevo elemento
        const nuevaBanda = document.createElement('div');
        nuevaBanda.className = 'banda-item mb-2 d-flex align-items-center';
        nuevaBanda.innerHTML = `
          <input type="text" class="form-control me-2" value="${nombreBanda}" readonly>
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentNode.remove()">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        // Insertar antes del campo de entrada
        bandasContainer.insertBefore(nuevaBanda, inputBanda.parentNode);
        
        // Limpiar campo
        inputBanda.value = '';
      } catch (error) {
        console.error("Error en agregarBanda:", error);
      }
    }
    // Función para actualizar el valor oculto de bandas criminales
    function actualizarBandasCriminales() {
      try {
        const bandas = [];
        document.querySelectorAll('.banda-item input').forEach(function(input) {
          if (input.value.trim()) {
            bandas.push(input.value.trim());
          }
        });
        
        // Si existe el campo oculto, actualizarlo
        const bandasInput = document.getElementById('bandasCriminalesJson');
        if (bandasInput) {
          bandasInput.value = JSON.stringify(bandas);
        }
      } catch (error) {
        console.error("Error al actualizar bandas criminales:", error);
      }
    }

    // Función para agregar cuenta de pago
    function agregarCuentaPago() {
      try {
        const cuentasContainer = document.getElementById('cuentas-pago-container');
        if (!cuentasContainer) return;
        
        const inputCuenta = cuentasContainer.querySelector('input[type="text"]');
        if (!inputCuenta) return;
        
        const cuenta = inputCuenta.value.trim();
        if (!cuenta) {
          alert("Por favor ingrese un número o cuenta");
          return;
        }
        
        // Crear nuevo elemento
        const nuevaCuenta = document.createElement('div');
        nuevaCuenta.className = 'cuenta-item mb-2 d-flex align-items-center';
        nuevaCuenta.innerHTML = `
          <input type="text" class="form-control me-2" value="${cuenta}" readonly>
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentNode.remove()">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        // Insertar antes del campo de entrada
        cuentasContainer.insertBefore(nuevaCuenta, inputCuenta.parentNode);
        
        // Limpiar campo
        inputCuenta.value = '';
      } catch (error) {
        console.error("Error en agregarCuentaPago:", error);
      }
    }

    // Función para actualizar el valor oculto de cuentas de pago
    function actualizarCuentasPago() {
      try {
        const cuentas = [];
        document.querySelectorAll('.cuenta-item input').forEach(function(input) {
          if (input.value.trim()) {
            cuentas.push(input.value.trim());
          }
        });
        
        // Si existe el campo oculto, actualizarlo
        const cuentasInput = document.getElementById('cuentasPagoJson');
        if (cuentasInput) {
          cuentasInput.value = JSON.stringify(cuentas);
        }
      } catch (error) {
        console.error("Error al actualizar cuentas de pago:", error);
      }
    }
    //----------------------------------------------------------


    // Función para obtener instrumentos de extorsión
    function obtenerInstrumentosExtorsion() {
      const instrumentos = [];
      
      // Verificar checkboxes
      if (document.getElementById('instrumento-motos')?.checked) {
        instrumentos.push('Motos');
      }
      
      if (document.getElementById('instrumento-carros')?.checked) {
        instrumentos.push('Carros');
      }
      
      // Si "Otros" está marcado, agregar los instrumentos personalizados
      if (document.getElementById('instrumento-otro')?.checked) {
        document.querySelectorAll('.otro-instrumento-input').forEach(function(input) {
          if (input.value.trim()) {
            instrumentos.push(input.value.trim());
          }
        });
      }
      
      return instrumentos;
    }

    // Función para obtener forma de pago
    function obtenerFormaPago() {
      const formaPago = document.getElementById('formaPago')?.value;
      
      if (formaPago === 'Otro') {
        return document.getElementById('otraFormaPago')?.value || 'Otro';
      }
      
      return formaPago || '';
    }

    
    // Función para recopilar instrumentos de extorsión
    // Actualiza tu función para recopilar instrumentos
    function recopilarInstrumentosExtorsion() {
      try {
        const instrumentos = [];
        
        // Verificar checkboxes estándar
        document.querySelectorAll('.instrumento-check:checked').forEach(function(checkbox) {
          instrumentos.push(checkbox.value);
        });
        
        // Verificar "Otro" checkbox
        if (document.getElementById('instrumento-otro') && 
            document.getElementById('instrumento-otro').checked) {
          
          // Agregar el valor del campo de texto
          const otroTexto = document.getElementById('instrumento-otro-texto');
          if (otroTexto && otroTexto.value.trim()) {
            instrumentos.push(otroTexto.value.trim());
          }
          
          // Agregar otros instrumentos de la lista
          document.querySelectorAll('#otros-instrumentos-lista .otro-instrumento').forEach(function(item) {
            instrumentos.push(item.textContent.trim());
          });
        }
        
        // Actualizar el campo oculto
        const instrumentosJson = document.getElementById('instrumentosJson');
        if (instrumentosJson) {
          instrumentosJson.value = JSON.stringify(instrumentos);
        }
        
        return instrumentos;
      } catch (error) {
        console.error("Error al recopilar instrumentos:", error);
        return [];
      }
    }

    // Función para agregar otro instrumento
    function agregarOtroInstrumento() {
      try {
        const input = document.getElementById('instrumento-otro-texto');
        if (!input) return;
        
        const valor = input.value.trim();
        if (!valor) {
          alert("Por favor ingrese un instrumento");
          return;
        }
        
        // Crear elemento para mostrar el instrumento agregado
        const lista = document.getElementById('otros-instrumentos-lista');
        if (!lista) return;
        
        const div = document.createElement('div');
        div.className = 'alert alert-info d-flex justify-content-between align-items-center mb-2 py-1 px-2';
        div.innerHTML = `
          <span class="otro-instrumento">${valor}</span>
          <button type="button" class="btn btn-sm btn-close" onclick="this.parentElement.remove(); recopilarInstrumentosExtorsion();"></button>
        `;
        
        lista.appendChild(div);
        
        // Limpiar el campo de entrada
        input.value = '';
        
        // Actualizar JSON
        recopilarInstrumentosExtorsion();
      } catch (error) {
        console.error("Error en agregarOtroInstrumento:", error);
      }
    }
    
    // Función para limpiar el formulario
    function limpiarFormulario() {
      document.getElementById('casoForm').reset();
      document.getElementById('id').value = '';
      document.getElementById('modoEdicion').value = 'false';
      modoEdicion = false;
      
      // Limpiar elementos dinámicos
      agraviados = [];
      actualizarListaAgraviados();
      
      denunciados = [];
      actualizarListaDenunciados();
      
      numerosTelefonicos = [];
      actualizarListaNumeros();
      
      imeisTelefonicos = [];
      actualizarListaImeis();
      
      titularesPago = [];
      actualizarListaTitulares();
      
      // Ocultar campos adicionales
      document.getElementById('tipoPagoOtroContainer').style.display = 'none';
      document.getElementById('instrumento-otro-texto').style.display = 'none';
      
      // Cambiar texto del botón
      document.getElementById('btnGuardar').innerHTML = '<i class="fas fa-save me-2"></i>Guardar Registro';
    }
    
    // Funciones para manejar elementos dinámicos
    
    // Agraviados
    function agregarAgraviado() {
      const nuevoAgraviado = {
        id: generarId(),
        nombre: ''
      };
      
      agraviados.push(nuevoAgraviado);
      actualizarListaAgraviados();
    }
    
    function actualizarListaAgraviados() {
      const container = document.getElementById('agraviados-container');
      container.innerHTML = '';
      
      agraviados.forEach(function(agraviado, index) {
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1 me-2">
              <input type="text" class="form-control agraviado-input" 
                  placeholder="Nombre del agraviado" 
                  value="${agraviado.nombre}" 
                  data-id="${agraviado.id}"
                  onchange="actualizarAgraviado('${agraviado.id}', this.value)">
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarAgraviado('${agraviado.id}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('agraviadosJson').value = JSON.stringify(agraviados);
    }
    
    function actualizarAgraviado(id, nombre) {
      const index = agraviados.findIndex(a => a.id === id);
        if (index !== -1) {
          agraviados[index].nombre = nombre;
          document.getElementById('agraviadosJson').value = JSON.stringify(agraviados);
       }
    }
      
    function eliminarAgraviado(id) {
      agraviados = agraviados.filter(a => a.id !== id);
      actualizarListaAgraviados();
    }
      
    // Denunciados
    function agregarDenunciado() {
      const nuevoDenunciado = {
        id: generarId(),
        nombre: ''
      };
        
      denunciados.push(nuevoDenunciado);
      actualizarListaDenunciados();
    }
      
    function actualizarListaDenunciados() {
      const container = document.getElementById('denunciados-container');
       container.innerHTML = '';
        
      denunciados.forEach(function(denunciado, index) {
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1 me-2">
              <input type="text" class="form-control denunciado-input" 
                  placeholder="Nombre o alias del denunciado" 
                  value="${denunciado.nombre}" 
                  data-id="${denunciado.id}"
                  onchange="actualizarDenunciado('${denunciado.id}', this.value)">
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarDenunciado('${denunciado.id}')">
              <i class="fas fa-times"></i>
            /button>
          </div>
          `;
          container.appendChild(div);
        });
        
        document.getElementById('denunciadosJson').value = JSON.stringify(denunciados);
      }
      
    function actualizarDenunciado(id, nombre) {
      const index = denunciados.findIndex(d => d.id === id);
      if (index !== -1) {
        denunciados[index].nombre = nombre;
        document.getElementById('denunciadosJson').value = JSON.stringify(denunciados);
      }
    }
      
    function eliminarDenunciado(id) {
      denunciados = denunciados.filter(d => d.id !== id);
      actualizarListaDenunciados();
    }
    
      
    // Números Telefónicos
    function agregarNumeroTelefonico() {
      numerosTelefonicos.push('');
      actualizarListaNumeros();
    }
      
    function actualizarListaNumeros() {
      const container = document.getElementById('numeros-container');
      container.innerHTML = '';
        
      numerosTelefonicos.forEach(function(numero, index) {
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1 me-2">
              <input type="text" class="form-control numero-input" 
                  placeholder="Número telefónico" 
                  value="${numero}" 
                  onchange="actualizarNumero(${index}, this.value)">
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarNumero(${index})">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
          container.appendChild(div);
      });
        
      document.getElementById('numerosTelefonicosJson').value = JSON.stringify(numerosTelefonicos);
    }
      
    function actualizarNumero(index, valor) {
      if (index >= 0 && index < numerosTelefonicos.length) {
        numerosTelefonicos[index] = valor;
        document.getElementById('numerosTelefonicosJson').value = JSON.stringify(numerosTelefonicos);
      }
    }
      
    function eliminarNumero(index) {
      numerosTelefonicos.splice(index, 1);
      actualizarListaNumeros();
    }
      
    // IMEI Telefónicos
    function agregarImeiTelefonico() {
      imeisTelefonicos.push('');
      actualizarListaImeis();
    }
      
    function actualizarListaImeis() {
      const container = document.getElementById('imeis-container');
      container.innerHTML = '';
        
      imeisTelefonicos.forEach(function(imei, index) {
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1 me-2">
              <input type="text" class="form-control imei-input" 
                  placeholder="IMEI del teléfono" 
                  value="${imei}" 
                  onchange="actualizarImei(${index}, this.value)">
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarImei(${index})">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        container.appendChild(div);
      });
        
      document.getElementById('imeisTelefonicosJson').value = JSON.stringify(imeisTelefonicos);
    }
      
    function actualizarImei(index, valor) {
      if (index >= 0 && index < imeisTelefonicos.length) {
        imeisTelefonicos[index] = valor;
        document.getElementById('imeisTelefonicosJson').value = JSON.stringify(imeisTelefonicos);
      }
    }
      
    function eliminarImei(index) {
      imeisTelefonicos.splice(index, 1);
       actualizarListaImeis();
    }
      
    // Titulares de Pago
    function agregarTitularPago() {
      titularesPago.push('');
      actualizarListaTitulares();
    }
      
    function actualizarListaTitulares() {
      const container = document.getElementById('titulares-container');
      container.innerHTML = '';
        
      titularesPago.forEach(function(titular, index) {
        const div = document.createElement('div');
        div.className = 'dynamic-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1 me-2">
              <input type="text" class="form-control titular-input" 
                  placeholder="Nombre del titular" 
                  value="${titular}" 
                  onchange="actualizarTitular(${index}, this.value)">
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarTitular(${index})">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        container.appendChild(div);
      });
        
      document.getElementById('titularesPagoJson').value = JSON.stringify(titularesPago);
    }
      
    function actualizarTitular(index, valor) {
      if (index >= 0 && index < titularesPago.length) {
        titularesPago[index] = valor;
        document.getElementById('titularesPagoJson').value = JSON.stringify(titularesPago);
      }
    }
      
    function eliminarTitular(index) {
      titularesPago.splice(index, 1);
      actualizarListaTitulares();
    }
      
    // Funciones para gestionar registros
    
    function cargarRegistrosLocales() {
      mostrarCargando();
      
      // Para depuración
      console.log("Iniciando carga de registros");
      
      google.script.run
        .withSuccessHandler(function(datos) {
          ocultarCargando();
          
          // Para depuración
          console.log("Datos recibidos en cargarRegistrosLocales:", datos);
          console.log("Tipo de datos:", typeof datos);
          console.log("¿Es array?", Array.isArray(datos));
          console.log("Longitud:", datos ? datos.length : 0);
          
          // Asegurarse de que datos es un array
          if (!datos) datos = [];
          if (!Array.isArray(datos)) datos = [datos];
          
          mostrarRegistrosEnTabla(datos);
        })
        .withFailureHandler(function(error) {
          ocultarCargando();
          console.error('Error al cargar registros:', error);
          mostrarAlerta('Error al cargar registros: ' + error, 'danger');
        })
        .obtenerRegistros();
    }


    //nuevo------------------------ SE PUEDE BORRAR
    function diagnosticarRegistros() {
      try {
        var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        var sheet = ss.getSheetByName("Hoja 1") || ss.getActiveSheet();
        var data = sheet.getDataRange().getValues();
        
        Logger.log("Total de filas: " + data.length);
        
        // Si hay al menos encabezados y una fila de datos
        if (data.length > 1) {
          Logger.log("Primera fila (encabezados): " + JSON.stringify(data[0]));
          Logger.log("Segunda fila (primer registro): " + JSON.stringify(data[1]));
        }
        
        // Ahora, veamos qué devuelve obtenerRegistros
        var registros = obtenerRegistros();
        Logger.log("Registros obtenidos: " + registros.length);
        
        if (registros.length > 0) {
          Logger.log("Primer registro: " + JSON.stringify(registros[0]));
        }
        
        return {
          filas: data.length,
          registrosObtenidos: registros.length
        };
      } catch (error) {
        return {
          error: error.toString()
        };
      }
    }
    //-------------------


    //----------------------------------------------------------------------------------
    // Mostrar registros en la tabla

    function mostrarRegistrosEnTabla(datos) {
      const tbody = document.getElementById('registros-body');
      const noRegistrosMessage = document.getElementById('no-registros-message');
      
      // Para depuración
      console.log("Datos recibidos en mostrarRegistrosEnTabla:", datos);
      console.log("Tipo de datos:", typeof datos);
      console.log("¿Es array?", Array.isArray(datos));
      console.log("Longitud:", datos ? datos.length : 0);
      
      // Limpiar tabla
      tbody.innerHTML = '';
      
      if (!datos || datos.length === 0) {
        console.log("No hay datos para mostrar");
        noRegistrosMessage.style.display = 'block';
        return;
      }
      
      noRegistrosMessage.style.display = 'none';
      
      // Mostrar datos simplificados para pruebas
      datos.forEach(function(registro, index) {
        console.log("Procesando registro:", index, registro);
        
        const row = document.createElement('tr');
        
        // Crear una representación simple del registro
        let htmlContent = '';
        
        // Intentar mostrar campos clave si existen
        htmlContent += `<td>${registro.carpetaFiscal || registro.id || 'N/A'}</td>`;
        htmlContent += `<td>${registro.fiscalacargo || 'N/A'}</td>`;
        htmlContent += `<td>${registro.fechadeingreso || 'N/A'}</td>`;
        
        // Para agraviados, verificar estructura
        let agraviadosTexto = 'N/A';
        if (registro.agraviados) {
          if (Array.isArray(registro.agraviados)) {
            agraviadosTexto = registro.agraviados.map(a => a.nombre || a).join(', ');
          } else {
            agraviadosTexto = String(registro.agraviados);
          }
        }
        
        htmlContent += `<td>${agraviadosTexto}</td>`;
        htmlContent += `<td>
          <button type="button" class="btn-icon btn-view" onclick="verDetalle(${index})">
            <i class="fas fa-eye"></i>
          </button>
        </td>`;
        
        row.innerHTML = htmlContent;
        tbody.appendChild(row);
      });
    }


  
    //-------------------------------------------------------------------------------------------------
    
    // Ver detalle de un registro
    function verDetalle(index) {
      const registro = registrosLocales[index];
      if (!registro) return;
      
      const modalBody = document.getElementById('detalleModalBody');
      
      // Obtener textos formateados
      let agraviadosTexto = 'Ninguno';
      if (registro.agraviados && registro.agraviados.length > 0) {
        agraviadosTexto = registro.agraviados.map(a => a.nombre).join('<br>');
      }
      
      let denunciadosTexto = 'Ninguno';
      if (registro.denunciadosAlias && registro.denunciadosAlias.length > 0) {
        denunciadosTexto = registro.denunciadosAlias.map(d => d.nombre || d).join('<br>');
      }
      
      let instrumentosTexto = 'Ninguno';
      if (registro.instrumentosExtorsion && registro.instrumentosExtorsion.length > 0) {
        instrumentosTexto = registro.instrumentosExtorsion.join('<br>');
      }
      
      let numerosTexto = 'Ninguno';
      if (registro.numerosTelefonicos && registro.numerosTelefonicos.length > 0) {
        numerosTexto = registro.numerosTelefonicos.join('<br>');
      }
      
      // Crear contenido HTML para el modal
      const html = `
        <div class="container-fluid">
          <div class="row">
            <div class="col-12 mb-3">
              <h4 class="border-bottom pb-2">Información General</h4>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Fiscalía:</strong> ${registro.fiscalia || 'No especificado'}</p>
                  <p><strong>Fiscal a Cargo:</strong> ${registro.fiscalacargo || 'No especificado'}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Unidad de Inteligencia:</strong> ${registro.unidadInteligencia || 'No especificado'}</p>
                  <p><strong>Instructor a Cargo:</strong> ${registro.instructorCargo || 'No especificado'}</p>
                </div>
              </div>
            </div>
            
            <div class="col-12 mb-3">
              <h4 class="border-bottom pb-2">Detalles del Caso</h4>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Forma de Inicio:</strong> ${registro.formaInicio || 'No especificado'}</p>
                  <p><strong>Carpeta Fiscal:</strong> ${registro.carpetaFiscal || 'No especificado'}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Fecha del Hecho:</strong> ${registro.fechaHecho || 'No especificado'}</p>
                  <p><strong>Fecha Ingreso Carpeta:</strong> ${registro.fechaIngresoFiscal || 'No especificado'}</p>
                  <p><strong>Fecha de Ingreso:</strong> ${registro.fechadeingreso || 'No especificado'}</p>
                </div>
              </div>
            </div>
            
            <div class="col-12 mb-3">
              <h4 class="border-bottom pb-2">Agraviado</h4>
              <p><strong>Tipo de Agraviado:</strong> ${registro.tipoAgraviado || 'No especificado'}</p>
              <p><strong>Agraviados:</strong><br>${agraviadosTexto}</p>
            </div>
            
            <div class="col-12 mb-3">
              <h4 class="border-bottom pb-2">Denunciado</h4>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Delitos:</strong> ${registro.delitos || 'No especificado'}</p>
                  <p><strong>Lugar de los Hechos:</strong> ${registro.lugarHechos || 'No especificado'}</p>
                  <p><strong>Denunciados/Alias:</strong><br>${denunciadosTexto}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Datos de Interés:</strong> ${registro.datosInteresDenunciado || 'Ninguno'}</p>
                  <p><strong>Banda Criminal:</strong> ${registro.nombreBandaCriminal || 'No especificado'}</p>
                  <p><strong>Cantidad Miembros:</strong> ${registro.cantidadMiembrosBanda || 'No especificado'}</p>
                </div>
              </div>
            </div>
            
            <div class="col-12 mb-3">
              <h4 class="border-bottom pb-2">Instrumentos y Métodos</h4>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Instrumentos:</strong><br>${instrumentosTexto}</p>
                  <p><strong>Forma de Pago:</strong> ${registro.formaPago || 'No especificado'}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Números Telefónicos:</strong><br>${numerosTexto}</p>
                  <p><strong>Cuenta de Pago:</strong> ${registro.cuentaPago || 'No especificado'}</p>
                </div>
              </div>
            </div>
            
            <div class="col-12 mb-3">
              <h4 class="border-bottom pb-2">Sumilla de los Hechos</h4>
              <p>${registro.sumillaHechos || 'No hay sumilla disponible'}</p>
            </div>
            
            <div class="col-12">
              <h4 class="border-bottom pb-2">Observaciones</h4>
              <p>${registro.observaciones || 'No hay observaciones'}</p>
            </div>
          </div>
        </div>
      `;
      
      modalBody.innerHTML = html;
      
      // Guardar el índice del registro actual en el botón editar
      document.getElementById('btnEditarDesdeDetalle').setAttribute('data-index', index);
      
      // Mostrar el modal
      const modal = new bootstrap.Modal(document.getElementById('detalleModal'));
      modal.show();
    }  


    // Editar desde el modal de detalles
    function editarDesdeDetalle() {
      const index = document.getElementById('btnEditarDesdeDetalle').getAttribute('data-index');
      
      // Cerrar el modal de detalles
      const modal = bootstrap.Modal.getInstance(document.getElementById('detalleModal'));
      modal.hide();
      
      // Cambiar a la pestaña del formulario
      const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
      formTab.show();
      
      // Cargar los datos en el formulario
      editarRegistro(index);
    }
    
    // Editar registro
    function editarRegistro(index) {
      const registro = registrosLocales[index];
      if (!registro) return;
      
      // Cambiar a la pestaña del formulario si estamos en la pestaña de registros
      const formTab = document.getElementById('form-tab');
      const recordsTab = document.getElementById('records-tab');
      
      if (recordsTab.classList.contains('active')) {
        const tab = new bootstrap.Tab(formTab);
        tab.show();
      }
      
      // Establecer modo edición
      modoEdicion = true;
      document.getElementById('modoEdicion').value = 'true';
      document.getElementById('btnGuardar').innerHTML = '<i class="fas fa-save me-2"></i>Actualizar Registro';
      
      // Llenar el formulario con los datos del registro
      document.getElementById('id').value = registro.id;
      
      // Información General
      document.getElementById('fiscalia').value = registro.fiscalia || '';
      document.getElementById('fiscalacargo').value = registro.fiscalacargo || '';
      document.getElementById('unidadInteligencia').value = registro.unidadInteligencia || '';
      document.getElementById('instructorCargo').value = registro.instructorCargo || '';
      
      // Detalles del Caso
      document.getElementById('formaInicio').value = registro.formaInicio || '';
      document.getElementById('carpetaFiscal').value = registro.carpetaFiscal || '';
      document.getElementById('fechaHecho').value = registro.fechaHecho || '';
      document.getElementById('fechaIngresoFiscal').value = registro.fechaIngresoFiscal || '';
      document.getElementById('fechadeingreso').value = registro.fechadeingreso || '';
      
      // Información del Agraviado
      document.getElementById('tipoAgraviado').value = registro.tipoAgraviado || '';
      agraviados = Array.isArray(registro.agraviados) ? [...registro.agraviados] : [];
      actualizarListaAgraviados();
      
      // Información del Denunciado
      document.getElementById('delitos').value = registro.delitos || '';
      document.getElementById('lugarHechos').value = registro.lugarHechos || '';
      denunciados = Array.isArray(registro.denunciadosAlias) ? [...registro.denunciadosAlias] : [];
      actualizarListaDenunciados();
      document.getElementById('datosInteresDenunciado').value = registro.datosInteresDenunciado || '';
      document.getElementById('nombreBandaCriminal').value = registro.nombreBandaCriminal || '';
      document.getElementById('cantidadMiembrosBanda').value = registro.cantidadMiembrosBanda || '';
      document.getElementById('modalidadViolencia').value = registro.modalidadViolencia || '';
      document.getElementById('modalidadAmenaza').value = registro.modalidadAmenaza || '';
      document.getElementById('atentadosCometidos').value = registro.atentadosCometidos || '';
      
      // Instrumentos y Métodos de Extorsión
      cargarInstrumentosExtorsion(registro.instrumentosExtorsion);
      document.getElementById('formaPago').value = registro.formaPago || '';
      numerosTelefonicos = Array.isArray(registro.numerosTelefonicos) ? [...registro.numerosTelefonicos] : [];
      actualizarListaNumeros();
      imeisTelefonicos = Array.isArray(registro.imeisTelefonicos) ? [...registro.imeisTelefonicos] : [];
      actualizarListaImeis();
      document.getElementById('cuentaPago').value = registro.cuentaPago || '';
      titularesPago = Array.isArray(registro.titularesPago) ? [...registro.titularesPago] : [];
      actualizarListaTitulares();
      
      // Datos de Interés de Pagos
      document.getElementById('tipoPago').value = registro.tipoPago || '';
      if (registro.tipoPago === 'Otro') {
        document.getElementById('tipoPagoOtroContainer').style.display = 'block';
        document.getElementById('tipoPagoOtros').value = registro.tipoPagoOtros || '';
      } else {
        document.getElementById('tipoPagoOtroContainer').style.display = 'none';
      }
      document.getElementById('montoSolicitado').value = registro.montoSolicitado || '';
      document.getElementById('montoPagado').value = registro.montoPagado || '';
      document.getElementById('numeroPagos').value = registro.numeroPagos || '';
      
      // Sumilla y Observaciones
      document.getElementById('sumillaHechos').value = registro.sumillaHechos || '';
      document.getElementById('observaciones').value = registro.observaciones || '';
      
      // Desplazarse al inicio del formulario
      window.scrollTo(0, 0);
    }
    
    // Cargar instrumentos de extorsión
    function cargarInstrumentosExtorsion(instrumentos) {
      // Desmarcar todos los checkboxes
      document.querySelectorAll('.instrumento-check').forEach(function(check) {
        check.checked = false;
      });
      
      document.getElementById('instrumento-otro-texto').style.display = 'none';
      document.getElementById('instrumento-otro-texto').value = '';
      
      if (!Array.isArray(instrumentos) || instrumentos.length === 0) return;
      
      // Marcar los checkboxes correspondientes
      instrumentos.forEach(function(instrumento) {
        let encontrado = false;
        
        document.querySelectorAll('.instrumento-check').forEach(function(check) {
          if (check.value === instrumento) {
            check.checked = true;
            encontrado = true;
          }
        });
        
        // Si no se encontró entre los checkboxes predefinidos, agregarlo como "Otro"
        if (!encontrado && instrumento) {
          document.getElementById('instrumento-otro').checked = true;
          document.getElementById('instrumento-otro-texto').style.display = 'block';
          document.getElementById('instrumento-otro-texto').value = instrumento;
        }
      });
    }
    
    // Confirmar eliminación
    function confirmarEliminar(index) {
      const registro = registrosLocales[index];
      if (!registro) return;
      
      registroAEliminarId = registro.id;
      
      // Mostrar modal de confirmación
      const modal = new bootstrap.Modal(document.getElementById('eliminarModal'));
      modal.show();
    }
    
    // Eliminar registro
    function eliminarRegistro() {
      if (!registroAEliminarId) return;
      
      mostrarCargando();
      
      // Llamar al servidor para eliminar
      google.script.run
        .withSuccessHandler(function(result) {
          ocultarCargando();
          if (result.success) {
            mostrarAlerta('Registro eliminado correctamente.', 'success');
            
            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('eliminarModal'));
            modal.hide();
            
            // Recargar registros
            cargarRegistrosLocales();
          } else {
            mostrarAlerta('Error al eliminar: ' + result.message, 'danger');
          }
        })
        .withFailureHandler(function(error) {
          ocultarCargando();
          mostrarAlerta('Error al eliminar: ' + error, 'danger');
        })
        .eliminarRegistro(registroAEliminarId);
    }
    
    // Buscar registros
    function buscarRegistros() {
      const termino = document.getElementById('buscarRegistro').value.toLowerCase();
      
      if (!termino || termino.length < 2) {
        // Mostrar todos los registros si no hay término de búsqueda
        mostrarRegistrosEnTabla(registrosLocales);
        return;
      }
      
      // Filtrar registros por el término de búsqueda
      const resultados = registrosLocales.filter(function(registro) {
        return (
          (registro.fiscalia && registro.fiscalia.toLowerCase().includes(termino)) ||
          (registro.fiscalacargo && registro.fiscalacargo.toLowerCase().includes(termino)) ||
          (registro.carpetaFiscal && registro.carpetaFiscal.toLowerCase().includes(termino)) ||
          (registro.agraviados && registro.agraviados.some(a => a.nombre && a.nombre.toLowerCase().includes(termino))) ||
          (registro.denunciadosAlias && registro.denunciadosAlias.some(d => 
            (d.nombre && d.nombre.toLowerCase().includes(termino)) || 
            (typeof d === 'string' && d.toLowerCase().includes(termino))
          ))
        );
      });
      
      mostrarRegistrosEnTabla(resultados);
    }
  </script>
</body>
</html>
